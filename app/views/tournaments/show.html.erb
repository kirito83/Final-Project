<head>
	<title>Tournament Bracket Generator</title>
	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="http://underscorejs.org/underscore-min.js"></script>
	<style type="text/css">
			/*
 *  Flex Layout Specifics
 */
 main{
 	display:flex;
 	flex-direction:row;
 	justify-content: center;
 }
 .round{
 	display:flex;
 	flex-direction:column;
 	align-items: center;
 	width:200px;
 	list-style:none;
 	padding:0;
 }
 .round .spacer{ flex-grow:1; }
 .round .spacer:first-child,
 .round .spacer:last-child{ flex-grow:.5; }

 .round .game-spacer{
 	flex-grow:1;
 }

/*
 *  General Styles
 */
 body{
 	font-family:sans-serif;
 	font-size:small;
 	padding:10px;
 	line-height:1.4em;
 }

 li.game{
 	color: white;
 }

 li.game.winner{
 	font-weight:bold;
 	color: orange;
 }
 li.game span{
 	float:right;
 	margin-right:5px;
 }

 li.game-top { 
 	border-bottom:1px solid #000; 
 }

 li.game-spacer{ 
 	border-right:1px solid #000;
 	min-height:40px;
 }

 li.game-bottom{ 
 	border-top:1px solid #000;
 }

 .btn {
 	color: white;
 	font-size: 14px;
 }
 .btn:hover {
 	color: white;
 }

 .link {
 	text-decoration: none;
 	margin-left: 48.5%;
 	color: white;
 	font-size: 20px;
 }
 .link:hover {
 	color: white;
 }

 .btn-primary {
 	margin-left: 48%;
 }

 .btn-danger {
 	margin-left: 47%;
 }

</style>
</head>
<body>
	<div class='tabs'>

		<h1><%= @tournament.title %></h1>

		<h2 class='center'><%= @tournament.description %></h2>

		<br>

		<div class='table'>
			<div class='header'>
				<h3 class='btn btn-infos'>Infos</h3>
				<h3 class='btn btn-participants'>Participants</h3>
				<h3 class='btn btn-bracket'>Bracket</h3>
			</div>

			<hr>

			<div class='infos'>
				<p>Createur : <%=@tournament.creator.username %></p>
				<p>Date : <%= @tournament.date %></p>
				<p>Prix : <%= @tournament.pricepool %> euros</p>
			</div>
			<div class='participants'>
				<% @tournament.participants.each do |member| %>
				<p><%= member.username %></p>
				<% end %>
			</div>
			<div class='bracket'>
				<main id="tournament">
					<% @index = 0 %>
					<% if !([2, 4, 8, 16, 32].include?(@tournament.participants.length)) %>
					<ul class='round'>
						<% while (@length - @base > 0) do %>
						<li class="spacer">&nbsp;</li>

						<li class="game game-top"><%= @team[@index] %></li>
						<% @index += 1 %>
						<li class="game game-spacer">&nbsp;</li>
						<li class="game game-bottom "><%= @team[@index] %></li>

						<li class="spacer">&nbsp;</li>
						<% if Match.find_by(joueur1: @team[@index-1], joueur2: @team[@index]).nil? %>
						<% Match.create(joueur1: @team[@index-1], joueur2: @team[@index]) %>
						<% end %>
						<% @length -= 1 %>
						<% @index += 1 %>
						<% end %>
						<% while @index < @tournament.participants.length %>
						<li class="spacer">&nbsp;</li>

						<li class="game game-top winner"><%= @team[@index] %></li>
						<% u = User.find_by(username: @team[@index]) %>
						<% if u.points == 0 %>
						<% u.points += 1 %>
						<% u.save %>
						<% end %>
						<% @index += 1 %>
						<li class="game game-spacer">&nbsp;</li>
						<li class="game game-bottom">Casper</li>

						<li class="spacer">&nbsp;</li>
						<% end %>
					</ul>
					<% @rounds -= 1 %>
					<% @points_necessaires = 1 %>
					<% while (@rounds > 0) %>
					<ul class="round">
						<% @indice = 2**(@rounds-1) %>
						<% @test = 0 %>
						<% @team.each do |user| %>
						<% if User.find_by(username: user).points >= @points_necessaires %>
						<% if @test % 2 == 0  %>
						<li class="spacer">&nbsp;</li>
						<li class="game game-top"><%= user %></li>
						<% @test += 1 %>
						<% else %>
						<li class="game game-spacer">&nbsp;</li>
						<li class="game game-bottom "><%= user %></li>
						<li class="spacer">&nbsp;</li>
						<% @indice -= 1 %>
						<% @test += 1 %>
						<% end %>
						<% end %>
						<% end %>
						<% while @indice > 0 %>
						<% if @test % 2 == 0  %>
						<li class="spacer">&nbsp;</li>
						<li class="game game-top">undefined</li>
						<% @test += 1 %>
						<% else %>
						<li class="game game-spacer">&nbsp;</li>
						<li class="game game-bottom ">undefined</li>
						<li class="spacer">&nbsp;</li>
						<% @indice -= 1 %>
						<% @test += 1 %>
						<% end %>
						<% end %>
					</ul>
					<% @points_necessaires += 1 %>
					<% @rounds -= 1 %>
					<% end %>
					<% else %>
					<% while (@rounds > 0) do %>
					<ul class="round">
						<% @indice = @rounds %>
						<% if @index == 0 %>
						<% while @indice > 0 %>
						<li class="spacer">&nbsp;</li>

						<li class="game game-top"><%= @team[@index] %></li>
						<li class="game game-spacer">&nbsp;</li>
						<% @index += 1 %>
						<li class="game game-bottom "><%= @team[@index] %></li>

						<li class="spacer">&nbsp;</li>
						<% @index += 1 %>
						<% @indice -= 1 %>
						<% end %>
						<% else %>
						<% while @indice > 0 %>
						<li class="spacer">&nbsp;</li>

						<li class="game game-top">undefined</li>
						<li class="game game-spacer">&nbsp;</li>
						<li class="game game-bottom ">undefined</li>

						<li class="spacer">&nbsp;</li>
						<% @indice -= 1 %>
						<% end %>
						<% end %>
					</ul>
					<% @rounds -= 1 %>
					<% end %>
					<% end %>
				</main>
			</div>
		</div>
	</div>

	<br><br>

	<% if signed_in? && !(@tournament.participants.include?(current_user)) %>
	<%= button_to 'Participer', suscribe_tournament_path(@tournament), method: :post, class: 'btn btn-primary' %>
	<% elsif @tournament.participants.include?(current_user) %>
	<%= button_to 'Voir mon prochain match' %>
	<%= button_to 'Se desinscrire', unsuscribe_tournament_path(@tournament), method: :post, class: 'btn btn-danger' %>
	<% end %>

	<br><br>

	<%= link_to "Retour", '/tournaments', class: 'link' %>
</body>
